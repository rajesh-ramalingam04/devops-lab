pipeline {
    agent any
    environment {
        IMAGE_NAME = "python-app-image"
        IMAGE_TAG  = "v1"
        CONTAINER  = "python-app-container"
    }
    options {
        skipDefaultCheckout()
    }
    stages {
        stage('Checkout & Validate') {
            steps {
                checkout scm
                script {
                    def changes = sh(
                        script: 'git diff --name-only HEAD~1 HEAD | grep -E "^python/python-app/" || true',
                        returnStdout: true
                    ).trim()
                    
                    if (!changes) {
                        echo "No changes in python/python-app directory. Skipping build."
                        currentBuild.result = 'NOT_BUILT'
                        return
                    }
                    echo "Changes detected in python/python-app. Proceeding with build..."
                }
            }
        }
        stage('Build Docker New Image') {
            steps {
                sh '''
                    cd python/python-app
                    docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                '''
            }
        }
        stage('Stop and Remove old Container') {
            steps {
                sh '''
                    docker stop ${CONTAINER} || true
                    docker rm ${CONTAINER} || true
                '''
            }
        }
        stage('Run New Container') {
            steps {
                sh '''
                    docker run -d \
                    --name ${CONTAINER} \
                    -p 5000:5000 \
                    ${IMAGE_NAME}:${IMAGE_TAG}
                '''
            }
        }
    }
    post {
        success {
            echo "Pipeline Suceeded"
        }
        failure {
            echo "Pipeline Failed"
        }
        always {
            sh 'docker ps -a'
        }
    }
}